(output_files)=

# Output Files Reference

This guide provides a comprehensive reference for all output files generated by `gsMap3D`. Understanding these files is essential for interpreting results and performing downstream analyses.

## Output Directory Structure

After running `gsMap3D`, the output is organized under `{workdir}/{project_name}/` with the following structure:

```
{project_name}/
├── find_latent_representations/    # Step 1: Latent embeddings
├── latent_to_gene/                 # Step 2: Gene specificity scores
├── spatial_ldsc/                   # Step 3: Spatial LDSC results
├── cauchy_combination/             # Step 4: Region-level statistics
├── report_data/                    # Processed data for analysis
└── gsmap_web_report/               # Interactive web report
```

```{note}
For `spatial3D` datasets, additional 3D-specific files are generated in `report_data/spatial_3d/` and `gsmap_web_report/spatial_3d/`.
```

---

## Step 1: Latent Representations

**Directory:** `find_latent_representations/`

This directory contains the trained neural network model and the latent embeddings for each sample.

### Files

| File | Description |
|------|-------------|
| `{sample_name}_add_latent.h5ad` | H5AD file with added latent embeddings for each sample |
| `training_adata.h5ad` | Combined training data used for model training |
| `LGCN_model/gsMap_LGCN_.pt` | Trained PyTorch model weights |
| `find_latent_metadata.yaml` | Configuration and training metadata |

### Latent H5AD Structure

Each `{sample_name}_add_latent.h5ad` file contains the original data plus:

- **`adata.obsm['emb_cell']`**: Cell identity embedding (32-dimensional by default)
- **`adata.obsm['emb_niche']`**: Spatial niche embedding (32-dimensional by default)

### Metadata YAML

The `find_latent_metadata.yaml` contains:

```yaml
config:
  # Input configuration parameters
model_info:
  model_path: ...
  n_parameters: 2052647
  input_size: [2000, 6000]
  hidden_size: 128
  embedding_size: 32
training_info:
  n_cells_used: 47329
  n_genes_used: 2000
  n_common_genes: 33525
outputs:
  latent_files:
    sample1: /path/to/sample1_add_latent.h5ad
    ...
annotation_info:
  annotation_key: layer_guess
  n_classes: 7
  label_names: [Layer1, Layer2, ...]
```

---

## Step 2: Latent to Gene (GSS)

**Directory:** `latent_to_gene/`

This directory contains the gene specificity scores (GSS) computed for each spot.

### Files

| File | Description |
|------|-------------|
| `concatenated_latent_adata.h5ad` | Combined H5AD with all samples |
| `ranks.dat` | Memory-mapped gene expression ranks (n_spots × n_genes, float16) |
| `ranks.meta.json` | Metadata for ranks array (shape, dtype) |
| `marker_scores.dat` | Memory-mapped marker scores (n_spots × n_genes, float16) |
| `marker_scores.meta.json` | Metadata for marker scores array |
| `mean_frac.parquet` | Mean expression fraction per gene |
| `metadata.yaml` | Configuration and output paths |

### Check GSS

If you want to check the GSS values, gsMap3D provides the `load_marker_scores_memmap_format` Python API, which returns an AnnData object with all spot and gene metadata:

```python
from gsMap.spatial_ldsc.io import load_marker_scores_memmap_format
from gsMap.config import QuickModeConfig

# Create a minimal config with required paths
config = QuickModeConfig(
    workdir="path/to/workdir",
    project_name="your_project",
    ...
)

# Load marker scores as AnnData
gss_adata = load_marker_scores_memmap_format(config)

# Access marker scores as a matrix (spots × genes)
print(gss_adata.X.shape)  # (n_spots, n_genes)

# Access spot metadata
print(gss_adata.obs.head())

# Access gene names
print(gss_adata.var_names[:10])
```

Alternatively, you can manually load the raw memory-mapped arrays:

```python
import numpy as np
import json

# Load metadata
with open('marker_scores.meta.json') as f:
    meta = json.load(f)

# Load marker scores
marker_scores = np.memmap(
    'marker_scores.dat',
    dtype=meta['dtype'],
    mode='r',
    shape=tuple(meta['shape'])
)
```

### Check Homogeneous Spots

The `concatenated_latent_adata.h5ad` file contains three QC metrics in `adata.obs` that help assess the quality of homogeneous neighbor identification for each spot:

| Column | Description |
|--------|-------------|
| `gsMap_homo_neighbor_count` | Number of valid homogeneous neighbors found for the spot |
| `gsMap_homo_cell_sims_median` | Median cell embedding similarity between the spot and its homogeneous neighbors |
| `gsMap_homo_niche_sims_median` | Median niche embedding similarity (only present when dual embeddings are used) |

These metrics can be used to identify spots with poor homogeneous neighbor coverage:

```python
import scanpy as sc

# Load the concatenated latent adata
adata = sc.read_h5ad('latent_to_gene/concatenated_latent_adata.h5ad')

# Check median cell similarity distribution
print(adata.obs['gsMap_homo_cell_sims_median'].describe())
```



---

## Step 3: Spatial LDSC

**Directory:** `spatial_ldsc/`

This directory contains the cell-level trait association results from stratified LD score regression.

### Files

| File | Description |
|------|-------------|
| `{project_name}_{trait_name}.csv.gz` | Compressed CSV with per-spot LDSC results |

### CSV Columns

| Column | Type | Description |
|--------|------|-------------|
| `spot` | string | Spot identifier (`{barcode}\|{sample_name}`) |
| `beta` | float | Heritability enrichment coefficient |
| `se` | float | Standard error of beta |
| `z` | float | Z-score (beta / se) |
| `p` | float | P-value (one-tailed) |
| `neg_log10_p` | float | -log10(p-value) for visualization |

### Example

```csv
spot,beta,se,z,p,neg_log10_p
AAACAACGAATAGTTC-1|Cortex_151507,9.28e-09,3.58e-09,2.593,0.00476,2.323
AAACAAGTATCTCCCA-1|Cortex_151507,2.91e-09,1.89e-09,1.535,0.0624,1.205
```

---

## Step 4: Cauchy Combination

**Directory:** `cauchy_combination/`

This directory contains region-level and sample-level aggregated statistics.

### Files

| File | Description |
|------|-------------|
| `{project_name}_{trait}.{annotation}.cauchy.csv` | Aggregated Cauchy test results across all samples |
| `{project_name}_{trait}.{annotation}.sample_cauchy.csv` | Per-sample Cauchy test results |
| `{project_name}_combined_ldsc.parquet` | Combined LDSC results in Parquet format |

### Aggregated Cauchy CSV Columns

| Column | Type | Description |
|--------|------|-------------|
| `trait` | string | Trait name |
| `annotation_name` | string | Annotation column name |
| `annotation` | string | Annotation value (e.g., "Layer1", "WM") |
| `p_cauchy` | float | Cauchy combination p-value |
| `p_median` | float | Median p-value across spots |
| `top_95_quantile` | float | 95th percentile of -log10(p) |
| `sig_spots` | int | Number of significant spots (p < 0.05 after correction) |
| `total_spots` | int | Total spots in this annotation |

### Sample Cauchy CSV

Same columns as above, plus:

| Column | Type | Description |
|--------|------|-------------|
| `sample_name` | string | Sample identifier |


---

## Report Data

**Directory:** `report_data/`

This directory contains processed data files for downstream analysis and visualization.

### Core Files

| File | Description |
|------|-------------|
| `spot_metadata.csv` | Combined spatial LDSC results with -log10(p) values for each trait, plus spot coordinates and annotations |
| `gene_list.csv` | List of genes used in the analysis |
| `cauchy_results.csv` | Combined Cauchy results for all traits and annotations |

### Subdirectories

| Directory | Description |
|-----------|-------------|
| `gss_stats/` | Gene-trait correlation statistics |
| `manhattan_data/` | Manhattan plot data per trait |
| `spatial_3d/` | 3D spatial data (spatial3D only) |

### spot_metadata.csv

This is the primary file for downstream analysis, containing all spot-level information.

**Columns:**

| Column | Type | Description |
|--------|------|-------------|
| `spot` | string | Spot identifier |
| `sx` | float | 2D x-coordinate (pixels) |
| `sy` | float | 2D y-coordinate (pixels) |
| `3d_x` | float | 3D x-coordinate (spatial3D only) |
| `3d_y` | float | 3D y-coordinate (spatial3D only) |
| `3d_z` | float | 3D z-coordinate (spatial3D only) |
| `sample_name` | string | Sample identifier |
| `{trait_name}` | float | -log10(p-value) for each trait |
| `{annotation}` | string | Annotation values |

**Example:**

```csv
spot,sx,sy,3d_x,3d_y,3d_z,sample_name,Height,IQ,layer_guess
AAACAACGAATAGTTC-1|Cortex_151507,3276,2514,3276,2514,0.0,Cortex_151507,2.323,1.151,Layer1
AAACAAGTATCTCCCA-1|Cortex_151507,9178,8520,9178,8520,0.0,Cortex_151507,1.205,5.047,Layer3
```

### gene_list.csv

Simple list of genes used in the analysis:

```csv
gene
MOBP
SPP1
MAG
...
```

### gss_stats/gene_trait_correlation_{trait}.csv

Gene-trait correlation statistics for identifying putative causal genes.

**Columns:**

| Column | Type | Description |
|--------|------|-------------|
| `gene` | string | Gene symbol |
| `PCC` | float | Pearson correlation coefficient between GSS and trait association |
| `trait` | string | Trait name |
| `Annotation` | string | Annotation (cell type/region) with the highest median GSS for that gene |
| `Median_GSS` | float | Median gene specificity score in that annotation |

**Example:**

```csv
gene,PCC,trait,Annotation,Median_GSS
MOBP,0.226,Height,WM,7.969
SPP1,0.225,Height,WM,6.848
MAG,0.225,Height,WM,6.688
```

### manhattan_data/{trait}_manhattan.csv

Data for generating Manhattan plots in the reports.


### spatial_3d/ (spatial3D only)

| File | Description |
|------|-------------|
| `spatial_3d.h5ad` | H5AD file with 3D coordinates and trait values |

---

## Web Report

**Directory:** `gsmap_web_report/`

This directory contains a self-contained interactive web report.

### Structure

```
gsmap_web_report/
├── index.html                      # Main report entry point
├── report_meta.json                # Report configuration
├── js_lib/                         # JavaScript libraries
│   ├── alpine.min.js
│   ├── tailwind.min.js
│   └── plotly.min.js
├── js_data/                        # Data files for visualization
│   ├── sample_index.js
│   ├── report_meta.js
│   ├── cauchy_results.js
│   ├── umap_data.js
│   ├── manhattan_{trait}.js
│   ├── gss_stats/
│   │   └── gene_trait_correlation_{trait}.js
│   └── sample_{sample_name}_spatial.js
├── gene_diagnostic_plots/          # Gene expression diagnostic plots
│   └── {gene}_{sample_name}.png
└── spatial_3d/                     # 3D visualizations (spatial3D only)
    ├── spatial_3d_trait_{trait}.html
    └── spatial_3d_anno_{annotation}.html
```

### report_meta.json

Contains comprehensive metadata about the analysis:

```json
{
  "workdir": "/path/to/workdir",
  "project_name": "my_project",
  "dataset_type": "spatial3D",
  "traits": ["Height", "IQ"],
  "samples": ["sample1", "sample2", ...],
  "annotations": ["layer_guess"],
  "is_3d": true,
  "has_3d_widget": true,
  "umap_info": {
    "has_niche": true,
    "cell_emb_key": "emb_cell",
    "niche_emb_key": "emb_niche"
  }
}
```

---

## Viewing the Report

### Option 1: Local Viewing

Copy the `gsmap_web_report/` folder to your local machine and open `index.html` in a web browser.

```bash
# On your local machine
open gsmap_web_report/index.html
```

### Option 2: Web Server (Remote)

For remote servers, use the built-in report viewer:

```bash
# Start a web server on port 8080
gsmap report-view ./gsmap_web_report --port 8080 --no-browser
```

Then access the report at `http://your-server:8080` or set up SSH port forwarding:

```bash
# On your local machine
ssh -L 8080:localhost:8080 user@remote-server
```


---

## See Also

- {doc}`Key Concepts <key_concepts>`: Understanding the gsMap3D pipeline
- {doc}`2D Tutorial <2d_tutorial/index>`: Step-by-step 2D analysis guide
- {doc}`3D Tutorial <3d_tutorial/index>`: Step-by-step 3D analysis guide
- {doc}`CLI Reference <cli_reference>`: Complete command-line reference
