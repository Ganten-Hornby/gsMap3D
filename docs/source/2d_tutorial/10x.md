# Cases on 10x Visium 2D Data

Here we provide case applications based on 10x Visium data (which are not at single-cell resolution). For convenience, we used the `Quick Mode` here to analyze 10x Visium data.

A frequently asked question is how to provide annotations for 10x Visium data. Note that gsMap can run without annotations. The most convenient approaches are to either leave the `annotation` parameter unset or provide annotations from spatial clustering methods, such as [SpaGCN](https://github.com/jianhuupenn/SpaGCN).

**Note**: This tutorial is designed for 2D Visium spatial transcriptomics data. For 3D spatial data, please refer to the {doc}`3D Tutorial <../3d_tutorial/human_gastrulation>`.

## Preparation

Make sure you have {doc}`installed <../install>` the `gsMap` package before proceeding.

### 1. Download Dependencies

The `gsMap` package in quick mode requires the following resources:

- **LD reference panel weights**, for heritability partitioning.
- **SNP-to-gene weight matrix**, linking SNPs to gene expression specificity.
- **Homologous gene transformations file** (optional), to map genes between species.

To download all the required files:

```bash
wget https://yanglab.westlake.edu.cn/data/gsMap/gsMap_quick_mode_resource.tar.gz
tar -xvzf gsMap_quick_mode_resource.tar.gz
```

Directory structure:

```bash
tree -L 2 gsMap_quick_mode_resource

gsMap_quick_mode_resource/
├── 1000GP3_GRCh37_gencode_v46_protein_coding_ldscore_weights.h5ad
└── weights_hm3_no_hla
    ├── weights.1.l2.ldscore.gz
    ├── ...
    └── weights.22.l2.ldscore.gz
```

For homolog files (mouse/macaque to human gene mapping), download separately:

```bash
wget https://yanglab.westlake.edu.cn/data/gsMap/gsMap_homologs.tar.gz
tar -xvzf gsMap_homologs.tar.gz
```

### 2. Download Example Data

You can download the example 10x Visium data as follows:

```bash
wget https://yanglab.westlake.edu.cn/data/gsMap/Visium_example_data.tar.gz
tar -xvzf Visium_example_data.tar.gz
```

Directory structure:

```bash
tree -L 2 Visium_example_data/

Visium_example_data/
├── GWAS
│   ├── IQ_NG_2018.sumstats.gz
│   └── Serum_creatinine.sumstats.gz
└── ST
    ├── V1_Adult_Mouse_Brain_Coronal_Section.h5ad
    ├── V1_Mouse_Brain_Sagittal_Posterior_Section.h5ad
    └── V1_Mouse_Kidney.h5ad
```

### 3. Set up environment variables

Define resource directories to make commands more portable:

```bash
# Define resource and data directories
GSMAP_RESOURCE_DIR="./gsMap_quick_mode_resource"
HOMOLOG_DIR="./gsMap_homologs"
VISIUM_DATA_DIR="./Visium_example_data"
```

## Case 1: Mouse Brain Coronal Section

**Data**: Visium data of adult mouse coronal section
**Trait**: IQ
<span style="color:#31a354"> Required memory: ~12G </span>

````{tab} CLI
```bash
# Create output directory
mkdir -p ./gsmap_2d_tutorial/visium

# Run gsMap in quick mode
gsmap quick-mode \
    --workdir "./gsmap_2d_tutorial/visium" \
    --project-name "V1_Adult_Mouse_Brain_Coronal_Section" \
    --dataset-type "spatial2D" \
    --h5ad-path "${VISIUM_DATA_DIR}/ST/V1_Adult_Mouse_Brain_Coronal_Section.h5ad" \
    --homolog-file "${HOMOLOG_DIR}/mouse_human_homologs.txt" \
    --w-ld-dir "${GSMAP_RESOURCE_DIR}/weights_hm3_no_hla" \
    --snp-gene-weight-adata-path "${GSMAP_RESOURCE_DIR}/1000GP3_GRCh37_gencode_v46_protein_coding_ldscore_weights.h5ad" \
    --annotation "domain" \
    --spatial-key "spatial" \
    --data-layer "count" \
    --trait-name "IQ" \
    --sumstats-file "${VISIUM_DATA_DIR}/GWAS/IQ_NG_2018.sumstats.gz" \
    --plot-origin "lower"
```
````

````{tab} Python
```python
from gsMap.config import QuickModeConfig
from gsMap.pipeline import run_quick_mode

config = QuickModeConfig(
    workdir="./gsmap_2d_tutorial/visium",
    project_name="V1_Adult_Mouse_Brain_Coronal_Section",
    dataset_type="spatial2D",
    h5ad_path="./Visium_example_data/ST/V1_Adult_Mouse_Brain_Coronal_Section.h5ad",
    homolog_file="./gsMap_homologs/mouse_human_homologs.txt",
    w_ld_dir="./gsMap_quick_mode_resource/weights_hm3_no_hla",
    snp_gene_weight_adata_path="./gsMap_quick_mode_resource/1000GP3_GRCh37_gencode_v46_protein_coding_ldscore_weights.h5ad",
    annotation="domain",
    spatial_key="spatial",
    data_layer="count",
    sumstats_config_dict={"IQ": "./Visium_example_data/GWAS/IQ_NG_2018.sumstats.gz"},
    plot_origin="lower"
)

run_quick_mode(config)
```
````

## Case 2: Mouse Brain Sagittal Section

**Data**: Visium data of adult mouse sagittal section
**Trait**: IQ
<span style="color:#31a354"> Required memory: ~12G </span>

````{tab} CLI
```bash
gsmap quick-mode \
    --workdir "./gsmap_2d_tutorial/visium" \
    --project-name "V1_Mouse_Brain_Sagittal_Posterior_Section" \
    --dataset-type "spatial2D" \
    --h5ad-path "${VISIUM_DATA_DIR}/ST/V1_Mouse_Brain_Sagittal_Posterior_Section.h5ad" \
    --homolog-file "${HOMOLOG_DIR}/mouse_human_homologs.txt" \
    --w-ld-dir "${GSMAP_RESOURCE_DIR}/weights_hm3_no_hla" \
    --snp-gene-weight-adata-path "${GSMAP_RESOURCE_DIR}/1000GP3_GRCh37_gencode_v46_protein_coding_ldscore_weights.h5ad" \
    --annotation "domain" \
    --spatial-key "spatial" \
    --data-layer "count" \
    --trait-name "IQ" \
    --sumstats-file "${VISIUM_DATA_DIR}/GWAS/IQ_NG_2018.sumstats.gz" \
    --plot-origin "lower"
```
````

````{tab} Python
```python
from gsMap.config import QuickModeConfig
from gsMap.pipeline import run_quick_mode

config = QuickModeConfig(
    workdir="./gsmap_2d_tutorial/visium",
    project_name="V1_Mouse_Brain_Sagittal_Posterior_Section",
    dataset_type="spatial2D",
    h5ad_path="./Visium_example_data/ST/V1_Mouse_Brain_Sagittal_Posterior_Section.h5ad",
    homolog_file="./gsMap_homologs/mouse_human_homologs.txt",
    w_ld_dir="./gsMap_quick_mode_resource/weights_hm3_no_hla",
    snp_gene_weight_adata_path="./gsMap_quick_mode_resource/1000GP3_GRCh37_gencode_v46_protein_coding_ldscore_weights.h5ad",
    annotation="domain",
    spatial_key="spatial",
    data_layer="count",
    sumstats_config_dict={"IQ": "./Visium_example_data/GWAS/IQ_NG_2018.sumstats.gz"},
    plot_origin="lower"
)

run_quick_mode(config)
```
````

## Case 3: Mouse Kidney

**Data**: Visium data of adult mouse kidney
**Trait**: Serum creatinine
<span style="color:#31a354"> Required memory: ~8G </span>

````{tab} CLI
```bash
gsmap quick-mode \
    --workdir "./gsmap_2d_tutorial/visium" \
    --project-name "V1_Mouse_Kidney" \
    --dataset-type "spatial2D" \
    --h5ad-path "${VISIUM_DATA_DIR}/ST/V1_Mouse_Kidney.h5ad" \
    --homolog-file "${HOMOLOG_DIR}/mouse_human_homologs.txt" \
    --w-ld-dir "${GSMAP_RESOURCE_DIR}/weights_hm3_no_hla" \
    --snp-gene-weight-adata-path "${GSMAP_RESOURCE_DIR}/1000GP3_GRCh37_gencode_v46_protein_coding_ldscore_weights.h5ad" \
    --annotation "domain" \
    --spatial-key "spatial" \
    --data-layer "count" \
    --trait-name "Serum_creatinine" \
    --sumstats-file "${VISIUM_DATA_DIR}/GWAS/Serum_creatinine.sumstats.gz" \
    --plot-origin "lower"
```
````

````{tab} Python
```python
from gsMap.config import QuickModeConfig
from gsMap.pipeline import run_quick_mode

config = QuickModeConfig(
    workdir="./gsmap_2d_tutorial/visium",
    project_name="V1_Mouse_Kidney",
    dataset_type="spatial2D",
    h5ad_path="./Visium_example_data/ST/V1_Mouse_Kidney.h5ad",
    homolog_file="./gsMap_homologs/mouse_human_homologs.txt",
    w_ld_dir="./gsMap_quick_mode_resource/weights_hm3_no_hla",
    snp_gene_weight_adata_path="./gsMap_quick_mode_resource/1000GP3_GRCh37_gencode_v46_protein_coding_ldscore_weights.h5ad",
    annotation="domain",
    spatial_key="spatial",
    data_layer="count",
    sumstats_config_dict={"Serum_creatinine": "./Visium_example_data/GWAS/Serum_creatinine.sumstats.gz"},
    plot_origin="lower"
)

run_quick_mode(config)
```
````
