<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>

    <!-- Tailwind CSS (Local) -->
    <script src="js_lib/tailwindcss.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a' }
                    }
                }
            }
        }
    </script>

    <!-- Alpine.js (Local) -->
    <script defer src="js_lib/alpine.min.js"></script>

    <!-- Plotly.js (Local) - Deferred for faster initial load -->
    <script defer src="js_lib/plotly.min.js"></script>

    <style>
        [x-cloak] {
            display: none !important;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        .table-row-hover:hover {
            background-color: #f8fafc;
        }

        .gradient-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .plot-container {
            min-height: 450px;
            contain: layout style;
        }

        /* GPU-accelerated collapse animation */
        .section-content {
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
            transform-origin: top center;
            overflow: hidden;
        }

        .section-content.collapsed {
            opacity: 0;
            transform: scaleY(0);
            height: 0;
            pointer-events: none;
        }

        .section-content.expanded {
            opacity: 1;
            transform: scaleY(1);
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800 font-sans antialiased" x-data="gsMapApp()" x-init="init()" x-cloak>

    <!-- Header -->
    <header class="gradient-header text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-14">
                <div class="flex items-center gap-3">
                    <div class="bg-white/20 backdrop-blur-sm px-3 py-1 rounded-lg">
                        <span class="text-xl font-bold">gsMap</span>
                    </div>
                    <div class="hidden sm:block">
                        <h1 class="font-semibold">{{ project_name }}</h1>
                        <p class="text-xs text-white/70">{{ generated_at }}</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Loading Indicator in header -->
                    <span x-show="isLoading" class="inline-flex items-center text-sm text-white/80">
                        <svg class="spinner -ml-1 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none"
                            viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                        </svg>
                        Loading...
                    </span>
                    <div class="text-sm text-white/80">v{{ gsmap_version }}</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Layout: Sidebar + Main Content -->
    <div class="flex min-h-[calc(100vh-3.5rem)]">

        <!-- ==================== SIDEBAR ==================== -->
        <aside x-show="dataLoaded"
            class="w-64 bg-white border-r border-gray-200 flex-shrink-0 sticky top-14 h-[calc(100vh-3.5rem)] overflow-y-auto">
            <div class="p-4 space-y-6">
                <!-- Sidebar Header -->
                <div class="pb-3 border-b border-gray-200">
                    <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Controls</h2>
                </div>

                <!-- Trait Selector -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Trait</label>
                    <select x-model="selectedTrait" @change="onTraitChange()"
                        class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm p-2.5 border bg-white">
                        <template x-for="t in traits" :key="t">
                            <option :value="t" x-text="t"></option>
                        </template>
                    </select>
                </div>

                <!-- Annotation Category Selector -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Annotation</label>
                    <select x-model="selectedAnnotationCategory"
                        class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm p-2.5 border bg-white">
                        <template x-for="anno in annotations" :key="anno">
                            <option :value="anno" x-text="anno"></option>
                        </template>
                    </select>
                </div>

                <!-- Gene Selector (only top genes) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Top Gene <span class="text-gray-400 font-normal">(<span
                                x-text="topGenesDropdown.length"></span>)</span>
                    </label>
                    <select x-model="selectedGene" @change="onGeneChange()"
                        class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm p-2.5 border bg-white">
                        <template x-for="g in topGenesDropdown" :key="g.gene">
                            <option :value="g.gene" x-text="g.gene + ' (' + (g.PCC ? g.PCC.toFixed(3) : 'N/A') + ')'">
                            </option>
                        </template>
                    </select>
                </div>

                <!-- Summary Stats -->
                <div class="pt-4 border-t border-gray-200">
                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Summary</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-500">Traits</span>
                            <span class="font-medium text-gray-900" x-text="traits.length"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Samples</span>
                            <span class="font-medium text-gray-900" x-text="samples.length"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Annotations</span>
                            <span class="font-medium text-gray-900" x-text="annotations.length"></span>
                        </div>
                    </div>
                </div>

                <!-- Section Navigation -->
                <div class="pt-4 border-t border-gray-200">
                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Sections</h3>
                    <nav class="space-y-1">
                        <button
                            @click="sections.manhattan = true; $nextTick(() => document.getElementById('sec-manhattan')?.scrollIntoView({behavior: 'smooth'}))"
                            class="w-full text-left px-3 py-2 text-sm rounded-lg hover:bg-gray-100 text-gray-700">
                            1. Manhattan Plot
                        </button>
                        <button
                            @click="sections.gsmap = true; $nextTick(() => document.getElementById('sec-gsmap')?.scrollIntoView({behavior: 'smooth'}))"
                            class="w-full text-left px-3 py-2 text-sm rounded-lg hover:bg-gray-100 text-gray-700">
                            2. LDSC Results
                        </button>
                        <button
                            @click="sections.annotation = true; $nextTick(() => document.getElementById('sec-annotation')?.scrollIntoView({behavior: 'smooth'}))"
                            class="w-full text-left px-3 py-2 text-sm rounded-lg hover:bg-gray-100 text-gray-700">
                            3. Annotations
                        </button>
                        <button
                            @click="sections.genes = true; $nextTick(() => document.getElementById('sec-genes')?.scrollIntoView({behavior: 'smooth'}))"
                            class="w-full text-left px-3 py-2 text-sm rounded-lg hover:bg-gray-100 text-gray-700">
                            4. Gene Analysis
                        </button>
                        <button
                            @click="sections.cauchy = true; $nextTick(() => document.getElementById('sec-cauchy')?.scrollIntoView({behavior: 'smooth'}))"
                            class="w-full text-left px-3 py-2 text-sm rounded-lg hover:bg-gray-100 text-gray-700">
                            5. Cauchy Results
                        </button>
                        <button
                            @click="sections.info = true; $nextTick(() => document.getElementById('sec-info')?.scrollIntoView({behavior: 'smooth'}))"
                            class="w-full text-left px-3 py-2 text-sm rounded-lg hover:bg-gray-100 text-gray-700">
                            6. Run Info
                        </button>
                    </nav>
                </div>
            </div>
        </aside>

        <!-- ==================== MAIN CONTENT ==================== -->
        <main class="flex-1 p-6 space-y-6 overflow-y-auto">

            <!-- Debug info (hidden by default, shown if no data) -->
            <div x-show="!dataLoaded" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <p class="text-yellow-800 font-medium">Loading data...</p>
                <p class="text-yellow-600 text-sm mt-1">If this message persists, please check that js_data/ folder
                    exists
                    with the required .js files.</p>
            </div>

            <!-- ==================== SECTION 1: MANHATTAN PLOT ==================== -->
            <div id="sec-manhattan" x-show="dataLoaded"
                class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center cursor-pointer"
                    @click="sections.manhattan = !sections.manhattan">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-800">1. Manhattan Plot</h2>
                        <p class="text-sm text-gray-500">GWAS results. Red = top PCC genes. Green diamond = selected
                            gene.
                        </p>
                    </div>
                    <svg class="w-5 h-5 text-gray-500 transition-transform"
                        :class="sections.manhattan ? 'rotate-180' : ''" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
                <div class="section-content" :class="sections.manhattan ? 'expanded' : 'collapsed'">
                    <div id="manhattanPlot" class="plot-container w-full"></div>
                </div>
            </div>

            <!-- ==================== SECTION 2: gsMap LDSC Results ==================== -->
            <div id="sec-gsmap" x-show="dataLoaded"
                class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center cursor-pointer"
                    @click="sections.gsmap = !sections.gsmap">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-800">2. gsMap LDSC Results - <span
                                x-text="selectedTrait"></span></h2>
                        <p class="text-sm text-gray-500">Spatial distribution of -log10(p) values across samples.</p>
                    </div>
                    <svg class="w-5 h-5 text-gray-500 transition-transform" :class="sections.gsmap ? 'rotate-180' : ''"
                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
                <div class="section-content p-4" :class="sections.gsmap ? 'expanded' : 'collapsed'">
                    <img x-show="selectedTrait" :src="'spatial_plots/ldsc_' + selectedTrait + '.png'"
                        :alt="selectedTrait" class="w-full h-auto max-h-[700px] object-contain mx-auto" loading="lazy"
                        onerror="this.style.display='none';">
                    <p x-show="!selectedTrait" class="text-center text-gray-500 py-8">Select a trait to view the plot.
                    </p>
                </div>
            </div>

            <!-- ==================== SECTION 3: Annotation Distribution ==================== -->
            <div id="sec-annotation" x-show="dataLoaded"
                class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center cursor-pointer"
                    @click="sections.annotation = !sections.annotation">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-800">3. Annotation Distribution - <span
                                x-text="selectedAnnotationCategory"></span></h2>
                        <p class="text-sm text-gray-500">Spatial distribution of annotations across samples.</p>
                    </div>
                    <svg class="w-5 h-5 text-gray-500 transition-transform"
                        :class="sections.annotation ? 'rotate-180' : ''" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
                <div class="section-content p-4" :class="sections.annotation ? 'expanded' : 'collapsed'">
                    <img x-show="selectedAnnotationCategory"
                        :src="'annotation_plots/anno_' + selectedAnnotationCategory + '.png'"
                        :alt="selectedAnnotationCategory" class="w-full h-auto max-h-[700px] object-contain mx-auto"
                        loading="lazy" onerror="this.style.display='none';">
                    <p x-show="!selectedAnnotationCategory" class="text-center text-gray-500 py-8">Select an annotation
                        category to view the plot.</p>
                </div>
            </div>

            <!-- ==================== SECTION 4: Gene Analysis ==================== -->
            <div id="sec-genes" x-show="dataLoaded"
                class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center cursor-pointer"
                    @click="sections.genes = !sections.genes">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-800">4. Gene Analysis - <span
                                x-text="selectedGene"></span></h2>
                        <p class="text-sm text-gray-500">Gene expression and GSS distribution plots across all samples.
                        </p>
                    </div>
                    <svg class="w-5 h-5 text-gray-500 transition-transform" :class="sections.genes ? 'rotate-180' : ''"
                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
                <div class="section-content" :class="sections.genes ? 'expanded' : 'collapsed'">
                    <!-- Gene Plot Controls -->
                    <div class="p-4 bg-gray-50 border-b border-gray-200 flex items-center gap-6">
                        <span class="text-sm font-medium text-gray-700">View:</span>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="genePlotType" value="exp" x-model="genePlotType"
                                class="form-radio text-primary-600 focus:ring-primary-500 h-4 w-4">
                            <span class="ml-2 text-sm text-gray-700">Expression</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="genePlotType" value="gss" x-model="genePlotType"
                                class="form-radio text-primary-600 focus:ring-primary-500 h-4 w-4">
                            <span class="ml-2 text-sm text-gray-700">GSS</span>
                        </label>
                    </div>

                    <!-- Gene Plot (Single view, switches between Expression and GSS) -->
                    <div class="p-4">
                        <div class="border border-gray-200 rounded-lg overflow-hidden">
                            <div class="bg-gray-50 px-4 py-2 border-b border-gray-200">
                                <h3 class="font-medium text-gray-700"
                                    x-text="genePlotType === 'exp' ? 'Gene Expression (All Samples)' : 'GSS Distribution (All Samples)'">
                                </h3>
                            </div>
                            <div class="p-2">
                                <img x-show="selectedGene && selectedTrait" :src="getGenePlotPath()"
                                    :alt="selectedGene + ' ' + (genePlotType === 'exp' ? 'expression' : 'GSS')"
                                    class="w-full h-auto object-contain max-h-[800px] mx-auto" loading="lazy"
                                    onerror="this.style.display='none';">
                                <p x-show="!selectedGene || !selectedTrait"
                                    class="text-center text-gray-400 py-8 text-sm">
                                    Select a gene to view the plot</p>
                            </div>
                        </div>
                    </div>

                    <!-- Gene Diagnostic Table -->
                    <div class="border-t border-gray-200">
                        <div class="p-4 bg-gray-50 flex justify-between items-center">
                            <h3 class="font-medium text-gray-700">Gene Diagnostic Table</h3>
                            <input type="text" x-model.debounce.300ms="geneSearchQuery" placeholder="Search genes..."
                                class="rounded-lg border-gray-300 shadow-sm text-sm p-2 border w-48">
                        </div>
                        <div class="overflow-x-auto overflow-y-auto custom-scrollbar max-h-[400px]"
                            @scroll="geneTableScroll = $event.target.scrollTop">
                            <div :style="{ minHeight: virtualGeneTable.totalHeight + 'px', position: 'relative' }">
                                <table class="min-w-full divide-y divide-gray-200"
                                    :style="{ position: 'absolute', top: virtualGeneTable.offsetY + 'px', left: 0, right: 0 }">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100"
                                                @click="sortGenesBy('gene')">Gene</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100"
                                                @click="sortGenesBy('PCC')">PCC</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100"
                                                @click="sortGenesBy('Annotation')">Annotation</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100"
                                                @click="sortGenesBy('Median_GSS')">Median GSS</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <template x-for="row in virtualGeneTable.items" :key="row.gene">
                                            <tr class="transition-colors duration-150"
                                                :style="{ height: geneTableRowHeight + 'px' }" :class="{
                                                'bg-primary-50': selectedGene === row.gene,
                                                'cursor-pointer hover:bg-gray-50': row.isTop,
                                                'cursor-not-allowed opacity-60 bg-gray-50': !row.isTop
                                            }" @click="if(row.isTop) { selectedGene = row.gene; onGeneChange(); }">
                                                <td class="px-4 py-2 text-sm text-gray-900"
                                                    :class="{'font-bold': row.isTop, 'font-medium': !row.isTop}"
                                                    x-text="row.gene"></td>
                                                <td class="px-4 py-2 text-sm text-gray-600 font-mono"
                                                    :class="{'font-bold': row.isTop}"
                                                    x-text="row.PCC ? row.PCC.toFixed(4) : 'N/A'"></td>
                                                <td class="px-4 py-2 text-sm"><span
                                                        class="px-2 py-0.5 text-xs rounded-full bg-gray-100"
                                                        x-text="row.Annotation || 'N/A'"></span></td>
                                                <td class="px-4 py-2 text-sm text-gray-600 font-mono"
                                                    x-text="row.Median_GSS ? row.Median_GSS.toFixed(4) : 'N/A'"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                            <div x-show="virtualGeneTable.totalCount > 0"
                                class="sticky bottom-0 bg-gray-100 text-xs text-gray-500 p-2 text-center border-t">
                                Showing <span x-text="virtualGeneTable.items.length"></span> of <span
                                    x-text="virtualGeneTable.totalCount"></span> genes
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== SECTION 5: CAUCHY COMBINATION ==================== -->
            <div id="sec-cauchy" x-show="dataLoaded"
                class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center cursor-pointer"
                    @click="sections.cauchy = !sections.cauchy">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-800">5. Cauchy Combination Results</h2>
                        <p class="text-sm text-gray-500">Statistical significance of annotations. Red = p &lt; 0.05</p>
                    </div>
                    <svg class="w-5 h-5 text-gray-500 transition-transform" :class="sections.cauchy ? 'rotate-180' : ''"
                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
                <div class="section-content" :class="sections.cauchy ? 'expanded' : 'collapsed'">
                    <!-- Cauchy Controls -->
                    <div class="p-4 bg-gray-50 border-b border-gray-200 flex flex-wrap gap-4">
                        <div class="flex items-center gap-2">
                            <label class="text-sm font-medium text-gray-700">View:</label>
                            <select x-model="cauchyViewMode" @change="renderCauchyHeatmap()"
                                class="rounded-lg border-gray-300 shadow-sm text-sm p-2 border bg-white">
                                <option value="all">All Samples (Aggregated)</option>
                                <option value="sample">Per Sample</option>
                            </select>
                        </div>
                    </div>

                    <!-- Cauchy Table -->
                    <div class="overflow-x-auto custom-scrollbar max-h-[400px]">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100"
                                        @click="sortCauchyBy('trait')">Trait</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100"
                                        @click="sortCauchyBy('annotation')">Annotation</th>
                                    <th x-show="cauchyViewMode === 'sample'"
                                        class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100"
                                        @click="sortCauchyBy('sample_name')">Sample</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100"
                                        @click="sortCauchyBy('p_cauchy')">P (Cauchy)</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100"
                                        @click="sortCauchyBy('p_median')">P (Median)</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Sig
                                        Spots
                                    </th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Total
                                        Spots
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template x-for="(row, idx) in filteredCauchyTable" :key="idx">
                                    <tr class="table-row-hover">
                                        <td class="px-4 py-2 text-sm font-medium text-gray-900" x-text="row.trait"></td>
                                        <td class="px-4 py-2 text-sm"><span
                                                class="px-2 py-0.5 text-xs rounded-full bg-primary-100 text-primary-700"
                                                x-text="row.annotation"></span></td>
                                        <td x-show="cauchyViewMode === 'sample'" class="px-4 py-2 text-sm text-gray-600"
                                            x-text="row.sample_name"></td>
                                        <td class="px-4 py-2 text-sm font-mono"
                                            :class="row.p_cauchy < 0.05 ? 'text-red-600 font-semibold' : 'text-gray-600'"
                                            x-text="row.p_cauchy != null ? row.p_cauchy.toExponential(2) : 'N/A'"></td>
                                        <td class="px-4 py-2 text-sm font-mono"
                                            :class="row.p_median < 0.05 ? 'text-red-600 font-semibold' : 'text-gray-600'"
                                            x-text="row.p_median != null ? row.p_median.toExponential(2) : 'N/A'"></td>
                                        <td class="px-4 py-2 text-sm text-gray-600" x-text="row.sig_spots"></td>
                                        <td class="px-4 py-2 text-sm text-gray-600" x-text="row.total_spots"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>

                    <!-- Cauchy Heatmap -->
                    <div class="border-t border-gray-200">
                        <div class="p-4 bg-gray-50 border-b border-gray-200">
                            <h3 class="font-medium text-gray-700">Cauchy P-Value Heatmap (Annotation vs Trait)</h3>
                        </div>
                        <div id="cauchyHeatmap" class="plot-container w-full"></div>
                    </div>
                </div>
            </div>

            <!-- ==================== SECTION 6: RUN INFO ==================== -->
            <div id="sec-info" x-show="dataLoaded"
                class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center cursor-pointer"
                    @click="sections.info = !sections.info">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-800">6. Run Information</h2>
                        <p class="text-sm text-gray-500">Configuration and summary statistics.</p>
                    </div>
                    <svg class="w-5 h-5 text-gray-500 transition-transform" :class="sections.info ? 'rotate-180' : ''"
                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
                <div class="section-content" :class="sections.info ? 'expanded' : 'collapsed'">
                    <!-- Summary Cards -->
                    <div class="p-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="text-center p-4 bg-primary-50 rounded-lg">
                            <p class="text-2xl font-bold text-primary-600" x-text="traits.length"></p>
                            <p class="text-sm text-gray-600">Traits</p>
                        </div>
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <p class="text-2xl font-bold text-green-600" x-text="samples.length"></p>
                            <p class="text-sm text-gray-600">Samples</p>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-lg">
                            <p class="text-2xl font-bold text-purple-600" x-text="annotations.length"></p>
                            <p class="text-sm text-gray-600">Annotation Categories</p>
                        </div>
                    </div>
                    <!-- Config JSON -->
                    <div class="border-t border-gray-200 p-4 bg-gray-50">
                        <h3 class="font-medium text-gray-700 mb-2">Configuration</h3>
                        <pre class="text-xs text-gray-600 whitespace-pre-wrap font-mono bg-white p-3 rounded border max-h-64 overflow-auto"
                            x-text="JSON.stringify(reportMeta, null, 2)"></pre>
                    </div>
                </div>
            </div>

        </main>
    </div><!-- End of flex layout -->

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200">
        <div class="max-w-full mx-auto px-4 py-3">
            <p class="text-center text-sm text-gray-500">gsMap Report | Version {{ gsmap_version }}</p>
        </div>
    </footer>

    <!-- Data Scripts - MUST load before Alpine initializes -->
    <script src="js_data/report_meta.js"></script>
    <script src="js_data/spot_metadata.js"></script>
    <script src="js_data/cauchy_results.js"></script>
    <script src="js_data/gene_trait_correlation.js"></script>

    <script>
        function gsMapApp() {
            return {
                // Data loaded flag
                dataLoaded: false,
                plotlyReady: false,

                // Global state
                selectedTrait: '',
                selectedAnnotationCategory: '',
                selectedGene: '',
                isLoading: false,
                genePlotType: 'exp',  // 'exp' for Expression, 'gss' for GSS

                // Data arrays (populated from window globals)
                traits: [],
                samples: [],
                annotations: [],
                topCorrGenes: 50,
                chromTickPositions: {},

                // Section collapse state
                sections: {
                    manhattan: true,
                    gsmap: true,
                    annotation: true,
                    genes: true,
                    cauchy: true,
                    info: false
                },

                // Raw data
                reportMeta: {},
                cauchyData: [],
                topGenesPcc: [],
                topGenesList: [],

                // Manhattan state
                manhattanLoadedTraits: {},
                manhattanData: null,
                manhattanPlotInitialized: false,
                manhattanTraceCache: null,
                chrColors: ['#1f77b4', '#aec7e8'],

                // Gene table state
                geneSearchQuery: '',
                geneSortKey: 'PCC',
                geneSortAsc: false,

                // Memoization caches
                _geneFilterCache: null,
                _geneFilterKey: '',
                _cauchyFilterCache: null,
                _cauchyFilterKey: '',

                // Virtual scrolling state
                geneTableScroll: 0,
                geneTableRowHeight: 40,
                geneTableVisibleCount: 12,

                // Cauchy state
                cauchyViewMode: 'all',
                cauchySortKey: 'p_median',
                cauchySortAsc: true,

                // Memoized: filtered gene table
                get filteredGeneTable() {
                    const key = `${this.selectedTrait}|${this.geneSearchQuery}|${this.geneSortKey}|${this.geneSortAsc}`;
                    if (this._geneFilterKey === key && this._geneFilterCache) {
                        return this._geneFilterCache;
                    }

                    let data = this.topGenesList || [];
                    if (this.geneSearchQuery) {
                        const q = this.geneSearchQuery.toLowerCase();
                        data = data.filter(r => r.gene.toLowerCase().includes(q));
                    }
                    const sortKey = this.geneSortKey, asc = this.geneSortAsc;
                    const result = [...data].sort((a, b) => {
                        let va = a[sortKey], vb = b[sortKey];
                        if (va == null) return 1;
                        if (vb == null) return -1;
                        if (typeof va === 'string') { va = va.toLowerCase(); vb = (vb || '').toLowerCase(); }
                        if (va < vb) return asc ? -1 : 1;
                        if (va > vb) return asc ? 1 : -1;
                        return 0;
                    });

                    this._geneFilterKey = key;
                    this._geneFilterCache = result;
                    return result;
                },

                // Virtual scrolling for gene table
                get virtualGeneTable() {
                    const allData = this.filteredGeneTable;
                    const start = Math.floor(this.geneTableScroll / this.geneTableRowHeight);
                    const buffer = 5;
                    const startIdx = Math.max(0, start - buffer);
                    const endIdx = Math.min(allData.length, start + this.geneTableVisibleCount + buffer * 2);

                    return {
                        items: allData.slice(startIdx, endIdx),
                        totalHeight: allData.length * this.geneTableRowHeight,
                        offsetY: startIdx * this.geneTableRowHeight,
                        totalCount: allData.length
                    };
                },

                // Dropdown list: only top N genes (for sidebar selector)
                get topGenesDropdown() {
                    return (this.topGenesList || []).filter(g => g.isTop);
                },

                // Memoized: filtered cauchy table
                get filteredCauchyTable() {
                    const key = `${this.selectedTrait}|${this.cauchyViewMode}|${this.cauchySortKey}|${this.cauchySortAsc}`;
                    if (this._cauchyFilterKey === key && this._cauchyFilterCache) {
                        return this._cauchyFilterCache;
                    }

                    let data = this.cauchyData || [];
                    data = data.filter(r => (this.cauchyViewMode === 'all' ? r.type === 'aggregated' : r.type === 'sample') && r.trait === this.selectedTrait);
                    const sortKey = this.cauchySortKey, asc = this.cauchySortAsc;
                    const result = [...data].sort((a, b) => {
                        let va = a[sortKey], vb = b[sortKey];
                        if (va == null) return 1;
                        if (vb == null) return -1;
                        if (typeof va === 'string') { va = (va || '').toLowerCase(); vb = (vb || '').toLowerCase(); }
                        if (va < vb) return asc ? -1 : 1;
                        if (va > vb) return asc ? 1 : -1;
                        return 0;
                    });

                    this._cauchyFilterKey = key;
                    this._cauchyFilterCache = result;
                    return result;
                },

                // Wait for Plotly to load (deferred)
                waitForPlotly() {
                    return new Promise(resolve => {
                        if (typeof Plotly !== 'undefined') {
                            this.plotlyReady = true;
                            return resolve();
                        }
                        const check = setInterval(() => {
                            if (typeof Plotly !== 'undefined') {
                                this.plotlyReady = true;
                                clearInterval(check);
                                resolve();
                            }
                        }, 50);
                    });
                },

                // Initialize
                async init() {
                    console.log("Initializing gsMap Report...");

                    // Load data from window globals
                    if (window.GSMAP_REPORT_META) {
                        this.reportMeta = window.GSMAP_REPORT_META;
                        this.traits = this.reportMeta.traits || [];
                        this.samples = this.reportMeta.samples || [];
                        this.annotations = this.reportMeta.annotations || [];
                        this.topCorrGenes = this.reportMeta.top_corr_genes || 50;
                        this.chromTickPositions = this.reportMeta.chrom_tick_positions || {};
                        console.log("Loaded report meta:", this.traits.length, "traits,", this.samples.length, "samples");
                    } else {
                        console.warn("GSMAP_REPORT_META not found!");
                    }

                    if (window.GSMAP_CAUCHY) {
                        this.cauchyData = window.GSMAP_CAUCHY;
                        console.log("Loaded", this.cauchyData.length, "Cauchy results");
                    }

                    if (window.GSMAP_GENE_TRAIT_CORRELATION) {
                        this.topGenesPcc = window.GSMAP_GENE_TRAIT_CORRELATION;
                        console.log("Loaded", this.topGenesPcc.length, "gene PCC records");
                    }

                    // Check if data loaded successfully
                    if (this.traits.length > 0) {
                        this.dataLoaded = true;

                        // Initialize selections
                        this.selectedTrait = this.traits[0];
                        if (this.annotations.length > 0) {
                            this.selectedAnnotationCategory = this.annotations[0];
                        }

                        // Update gene list
                        this.updateGeneList();

                        // Wait for Plotly to load, then render plots
                        await this.waitForPlotly();
                        this.loadManhattanData();
                        this.renderCauchyHeatmap();
                    } else {
                        console.error("No traits found - data may not have loaded correctly");
                    }
                },

                // Event handlers
                onTraitChange() {
                    this._geneFilterCache = null; // Invalidate cache
                    this._cauchyFilterCache = null;
                    this.manhattanTraceCache = null; // Invalidate Manhattan cache
                    this.updateGeneList();
                    this.loadManhattanData();
                },

                onGeneChange() {
                    if (this.manhattanData && this.plotlyReady) {
                        this.renderManhattanPlot();
                    }
                },

                // Update gene list when trait changes
                updateGeneList() {
                    const trait = this.selectedTrait;
                    if (!trait || !this.topGenesPcc || this.topGenesPcc.length === 0) {
                        this.topGenesList = [];
                        return;
                    }
                    let traitGenes = this.topGenesPcc
                        .filter(g => g.trait === trait)
                        .sort((a, b) => (b.PCC || 0) - (a.PCC || 0));

                    // Mark top genes
                    traitGenes.forEach((g, i) => {
                        g.isTop = i < this.topCorrGenes;
                    });

                    // Load ALL genes, not just top slice
                    this.topGenesList = traitGenes;

                    // Select first gene if available
                    if (this.topGenesList.length > 0) {
                        this.selectedGene = this.topGenesList[0].gene;
                    }
                },

                // Gene plot path (multi-sample, switches between exp and gss based on genePlotType)
                getGenePlotPath() {
                    return `gene_diagnostic_plots/gene_${this.selectedTrait}_${this.selectedGene}_${this.genePlotType}.png`;
                },

                // Sorting
                sortGenesBy(key) {
                    if (this.geneSortKey === key) this.geneSortAsc = !this.geneSortAsc;
                    else { this.geneSortKey = key; this.geneSortAsc = key === 'gene'; }
                },
                sortCauchyBy(key) {
                    if (this.cauchySortKey === key) this.cauchySortAsc = !this.cauchySortAsc;
                    else { this.cauchySortKey = key; this.cauchySortAsc = ['trait', 'annotation', 'sample_name'].includes(key); }
                },

                // Manhattan Plot
                loadManhattanData() {
                    const trait = this.selectedTrait;
                    if (!trait) return;

                    this.isLoading = true;
                    const safeTrait = trait.replace(/[^a-zA-Z0-9]/g, "_");
                    const varName = `GSMAP_MANHATTAN_${safeTrait}`;

                    // Check if already loaded
                    if (this.manhattanLoadedTraits[trait] && window[varName]) {
                        this.manhattanData = window[varName];
                        this.renderManhattanPlot();
                        this.isLoading = false;
                        return;
                    }

                    // Load script dynamically
                    const script = document.createElement('script');
                    script.src = `js_data/manhattan_${trait}.js`;
                    script.onload = () => {
                        this.manhattanLoadedTraits[trait] = true;
                        if (window[varName]) {
                            this.manhattanData = window[varName];
                            this.renderManhattanPlot();
                        }
                        this.isLoading = false;
                    };
                    script.onerror = () => {
                        console.error(`Failed to load Manhattan data for ${trait}`);
                        this.isLoading = false;
                    };
                    document.body.appendChild(script);
                },

                renderManhattanPlot() {
                    const data = this.manhattanData;
                    if (!data || !data.x || data.x.length === 0) return;

                    const plotDiv = document.getElementById('manhattanPlot');
                    if (!plotDiv) return;

                    const trait = this.selectedTrait;
                    const highlightGene = this.selectedGene ? this.selectedGene.toUpperCase() : '';

                    // Build or reuse cached base traces (regular + top PCC SNPs)
                    if (!this.manhattanTraceCache) {
                        const regularX = [], regularY = [], regularColors = [];
                        const topX = [], topY = [], topGenes = [], topSnps = [];

                        // Single pass through data to separate regular and top SNPs
                        for (let i = 0; i < data.x.length; i++) {
                            if (data.is_top && data.is_top[i] === 1) {
                                topX.push(data.x[i]);
                                topY.push(data.y[i]);
                                topGenes.push(data.gene[i] || '');
                                topSnps.push(data.snp[i] || '');
                            } else {
                                regularX.push(data.x[i]);
                                regularY.push(data.y[i]);
                                regularColors.push(this.chrColors[data.chr[i] % 2]);
                            }
                        }

                        // Calculate maxX
                        let maxX = 0;
                        for (let i = 0; i < data.x.length; i++) {
                            if (data.x[i] > maxX) maxX = data.x[i];
                        }

                        this.manhattanTraceCache = {
                            regularX, regularY, regularColors,
                            topX, topY, topGenes, topSnps,
                            maxX
                        };
                    }

                    const cache = this.manhattanTraceCache;
                    const traces = [];

                    // Regular SNPs - hover disabled for performance
                    if (cache.regularX.length > 0) {
                        traces.push({
                            x: cache.regularX,
                            y: cache.regularY,
                            mode: 'markers',
                            type: 'scattergl',
                            hoverinfo: 'skip', // Disable hover for performance
                            marker: { size: 3, color: cache.regularColors, opacity: 0.6 },
                            name: 'SNPs'
                        });
                    }

                    // Top PCC genes (red) - keep hover
                    if (cache.topX.length > 0) {
                        traces.push({
                            x: cache.topX,
                            y: cache.topY,
                            mode: 'markers',
                            type: 'scattergl',
                            text: cache.topGenes.map((g, i) => `<b>${g}</b><br>SNP: ${cache.topSnps[i]}<br>-log10(p): ${cache.topY[i].toFixed(2)}`),
                            hoverinfo: 'text',
                            marker: { size: 6, color: '#e53e3e', opacity: 0.85 },
                            name: 'Top PCC Genes'
                        });
                    }

                    // Highlighted gene (green diamond) - always rebuild this trace
                    if (highlightGene) {
                        const highlightX = [], highlightY = [], highlightText = [];
                        for (let i = 0; i < data.x.length; i++) {
                            if ((data.gene[i] || '').toUpperCase() === highlightGene) {
                                highlightX.push(data.x[i]);
                                highlightY.push(data.y[i]);
                                highlightText.push(`<b>${data.gene[i]}</b><br>SNP: ${data.snp[i] || ''}<br>-log10(p): ${data.y[i].toFixed(2)}`);
                            }
                        }
                        if (highlightX.length > 0) {
                            traces.push({
                                x: highlightX,
                                y: highlightY,
                                mode: 'markers',
                                type: 'scattergl',
                                hoverinfo: 'text',
                                hovertext: highlightText,
                                marker: { size: 12, color: '#10b981', symbol: 'diamond', line: { width: 2, color: '#059669' } },
                                name: 'Selected Gene'
                            });
                        }
                    }

                    // Get chromosome tick positions
                    const chromTicks = this.chromTickPositions[trait] || {};
                    const tickvals = Object.values(chromTicks);
                    const ticktext = Object.keys(chromTicks);

                    const layout = {
                        title: { text: `Manhattan Plot: ${trait}`, font: { size: 16 } },
                        xaxis: {
                            title: 'Chromosome',
                            showgrid: false,
                            zeroline: false,
                            tickvals: tickvals,
                            ticktext: ticktext
                        },
                        yaxis: { title: '-log10(p)', showgrid: true, gridcolor: '#eee', zeroline: false },
                        hovermode: 'closest',
                        margin: { l: 60, r: 30, t: 50, b: 50 },
                        legend: { orientation: 'h', y: -0.15 },
                        shapes: [{
                            type: 'line',
                            x0: 0,
                            x1: cache.maxX,
                            y0: -Math.log10(5e-8),
                            y1: -Math.log10(5e-8),
                            line: { color: '#e53e3e', width: 1, dash: 'dash' }
                        }]
                    };

                    const config = { responsive: true, displayModeBar: true };

                    // Use Plotly.react for efficient updates
                    if (this.manhattanPlotInitialized) {
                        Plotly.react(plotDiv, traces, layout, config);
                    } else {
                        Plotly.newPlot(plotDiv, traces, layout, config);
                        this.manhattanPlotInitialized = true;
                    }
                },

                // Cauchy Heatmap
                renderCauchyHeatmap() {
                    const plotDiv = document.getElementById('cauchyHeatmap');
                    if (!plotDiv || !this.cauchyData || this.cauchyData.length === 0) return;

                    let data = this.cauchyData.filter(r => this.cauchyViewMode === 'all' ? r.type === 'aggregated' : r.type === 'sample');
                    if (data.length === 0) {
                        Plotly.purge(plotDiv);
                        return;
                    }

                    // Use 'annotation' column (e.g., "WM", "Layer1") not 'annotation_name'
                    const annotationValues = [...new Set(data.map(r => r.annotation))].sort();
                    const traitValues = [...new Set(data.map(r => r.trait))].sort();

                    const zData = annotationValues.map(anno => traitValues.map(trait => {
                        const match = data.find(r => r.annotation === anno && r.trait === trait);
                        return match && match.p_median ? -Math.log10(match.p_median + 1e-300) : 0;
                    }));

                    Plotly.newPlot(plotDiv, [{
                        z: zData,
                        x: traitValues,
                        y: annotationValues,
                        type: 'heatmap',
                        colorscale: 'RdBu',
                        reversescale: true,
                        hovertemplate: 'Annotation: %{y}<br>Trait: %{x}<br>-log10(p_median): %{z:.2f}<extra></extra>'
                    }], {
                        title: 'Cauchy P-Value Heatmap (-log10 scale)',
                        xaxis: { title: 'Trait', tickangle: 45 },
                        yaxis: { title: 'Annotation' },
                        margin: { l: 120, r: 50, t: 60, b: 100 }
                    }, { responsive: true });
                }
            };
        }
    </script>

</body>

</html>